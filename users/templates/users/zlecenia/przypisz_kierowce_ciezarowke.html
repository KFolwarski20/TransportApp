{% extends 'base.html' %}
{% block title %}Przypisz Kierowcƒô i Ciƒô≈ºar√≥wkƒô{% endblock %}
{% block page_class %}page-bg-light{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-10 col-lg-8">
        <div class="card shadow-lg">
            <div class="card-header bg-primary text-white text-center">
                <h3 class="fw-bold"><i class="fa-solid fa-cogs"></i> Przypisz Kierowcƒô i Ciƒô≈ºar√≥wkƒô</h3>
            </div>
            <div class="card-body">
                {% if messages %}
                    {% for message in messages %}
                        <div class="alert alert-danger">{{ message }}</div>
                    {% endfor %}
                {% endif %}

                <h4 class="text-center mb-4"><i class="fa-solid fa-road"></i> Odleg≈Ço≈õƒá: {{ odleglosc }} km</h4>

                <!-- üó∫Ô∏è Miejsce na mapƒô -->
                <div id="map" style="height: 500px; border-radius: 15px; box-shadow: 0px 4px 8px rgba(0,0,0,0.2);" class="mt-3"></div>

                <form method="post" class="needs-validation" novalidate>
                    {% csrf_token %}
                    <input type="hidden" id="id_zlec" value="{{ id_zlec }}">
                    <div class="mb-3">
                        <label class="form-label fw-bold">Przewidywana data rozpoczƒôcia realizacji</label>
                        <input type="datetime-local" name="data_rozpoczecia_realizacji" id="dataRozpoczecia" class="form-control" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Przewidywana data zako≈Ñczenia realizacji</label>
                        <input type="text" id="dataZakonczenia" class="form-control" readonly>
                    </div>

                    <div class="mb-3 alert alert-info text-center">
                        <strong>‚è±Ô∏è Przewidywany czas realizacji:</strong>
                        <span id="czasRealizacji">‚Äî</span>
                    </div>

                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Wybierz kierowcƒô</label>
                            <select class="form-select" name="kierowca" id="kierowca" required>
                                <option value="">-- Wybierz kierowcƒô --</option>
                                {% for item in kierowcy_z_kosztami %}
                                    <option value="{{ item.id }}" data-koszt="{{ item.koszt }}">
                                        {{ item.imie }} {{ item.nazwisko }} - {{ item.koszt|floatformat:2 }} PLN
                                    </option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label fw-bold">Wybierz ciƒô≈ºar√≥wkƒô</label>
                            <select class="form-select" name="ciezarowka" id="ciezarowka" required>
                                <option value="">-- Wybierz ciƒô≈ºar√≥wkƒô --</option>
                                {% for item in ciezarowki_z_kosztami %}
                                    <option value="{{ item.id }}" data-koszt="{{ item.koszt }}">
                                        {{ item.marka }} {{ item.model }} - {{ item.koszt|floatformat:2 }} PLN
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <div id="lacznyKoszt" class="card border-primary mb-3 mt-4" style="display:none;">
                        <div class="card-body text-center">
                            <h5 class="card-title text-primary fw-bold">üí∞ Przewidywany koszt zlecenia:</h5>
                            <p class="card-text fs-3 fw-bold"><span id="kosztValue">0.00</span> PLN</p>
                        </div>
                    </div>

                    <div class="mt-4 text-center">
                        <button type="submit" name="confirm" class="btn btn-primary px-4">
                            <i class="fa-solid fa-check"></i> Potwierd≈∫
                        </button>
                        <a href="{% url 'zarzadzaj_zleceniami' %}" class="btn btn-outline-secondary px-4">Anuluj</a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

    <!-- Wczytanie Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const dataRozpoczecia = document.getElementById('dataRozpoczecia');
    const dataZakonczenia = document.getElementById('dataZakonczenia');
    const czasRealizacji = document.getElementById('czasRealizacji');
    const kierowcaSelect = document.getElementById('kierowca');
    const ciezarowkaSelect = document.getElementById('ciezarowka');
    const lacznyKosztDiv = document.getElementById('lacznyKoszt');
    const kosztValue = document.getElementById('kosztValue');

    const id_zlec = document.getElementById('id_zlec')?.value;
    const czasTrasySekundy = parseFloat("{{ czas_trasy_sek|default:0 }}");

    let debounceTimeout = null;

    function obliczDateZakonczenia() {
        if (!dataRozpoczecia.value) {
            dataZakonczenia.value = '';
            czasRealizacji.textContent = '‚Äî';
            return;
        }

        const startDate = new Date(dataRozpoczecia.value);
        if (isNaN(startDate.getTime())) {
            dataZakonczenia.value = '';
            czasRealizacji.textContent = '‚Äî';
            return;
        }

        // Obliczenia czasu trasy
        let czasPoRezerwie = 1.05 * czasTrasySekundy; // +5%
        let totalCzasSekundy = czasPoRezerwie;

        // Je≈õli czas > 4,5h (16200 sekund) i <= 9h (32400 sekund), dodaj 45 minut przerwy
        if (czasPoRezerwie > 16200 && czasPoRezerwie <= 32400) {
            totalCzasSekundy += 2700; // 45 min przerwy
        }

        // Je≈õli czas > 9h, dodaj odpoczynki
        if (czasPoRezerwie > 32400) {
            const maxJazdaNaDzien = 32400; // 9h jazdy
            const przerwaDzienna = 2700;    // 45 min

            let czasZRozbiciem = czasPoRezerwie + przerwaDzienna;
            let dniPelne = Math.floor(czasZRozbiciem / (maxJazdaNaDzien + przerwaDzienna));
            let pozostalyCzas = czasZRozbiciem % (maxJazdaNaDzien + przerwaDzienna);

            totalCzasSekundy = czasZRozbiciem + dniPelne * 54000; // dodajemy odpoczynek 15h za ka≈ºdy pe≈Çen dzie≈Ñ

            if (pozostalyCzas > maxJazdaNaDzien) {
                totalCzasSekundy += 54000; // 15h na odpoczynek
            }
        }

        const koniec = new Date(startDate.getTime() + totalCzasSekundy * 1000);

        // Wy≈õwietl koniec
        dataZakonczenia.value = koniec.toLocaleString('pl-PL', {
            day: '2-digit', month: '2-digit', year: 'numeric',
            hour: '2-digit', minute: '2-digit'
        });

        // Wy≈õwietl czas trwania
        const totalMinutes = Math.round(totalCzasSekundy / 60);
        const dni = Math.floor(totalMinutes / 1440);
        const godziny = Math.floor((totalMinutes % 1440) / 60);
        const minuty = totalMinutes % 60;

        let czasText = '';
        if (dni > 0) czasText += dni + " dni ";
        if (godziny > 0) czasText += godziny + " godz. ";
        if (minuty > 0) czasText += minuty + " min.";
        if (!czasText) czasText = "mniej ni≈º minuta";

        czasRealizacji.textContent = czasText;

        // ‚úÖ Pobierz dostƒôpnych kierowc√≥w i ciƒô≈ºar√≥wki
        pobierzDostepnych();
    }

    function pobierzDostepnych() {
        const data = dataRozpoczecia.value;
        if (!data) return;

        fetch(`/api/get_available_kierowcy_ciezarowki/${id_zlec}/?data_rozpoczecia=${encodeURIComponent(data)}`)
            .then(response => response.json())
            .then(data => {
                console.log("üîπ Otrzymane dane z API:", data);

                if (!kierowcaSelect || !ciezarowkaSelect) {
                    console.error("‚ùå Brak element√≥w select w DOM!");
                    return;
                }

                kierowcaSelect.innerHTML = "";
                ciezarowkaSelect.innerHTML = "";

                const kierowcaPlaceholder = new Option("-- Wybierz kierowcƒô --", "");
                const ciezarowkaPlaceholder = new Option("-- Wybierz ciƒô≈ºar√≥wkƒô --", "");
                kierowcaSelect.appendChild(kierowcaPlaceholder);
                ciezarowkaSelect.appendChild(ciezarowkaPlaceholder);

                if (data.kierowcy.length === 0) {
                    kierowcaSelect.appendChild(new Option("Brak dostƒôpnych kierowc√≥w", "", false, false)).disabled = true;
                } else {
                    data.kierowcy.forEach(k => {
                        const option = new Option(`${k.imie} ${k.nazwisko} - ${k.koszt.toFixed(2)} PLN`, k.id);
                        option.dataset.koszt = k.koszt.toFixed(2);
                        kierowcaSelect.appendChild(option);
                    });
                }

                if (data.ciezarowki.length === 0) {
                    ciezarowkaSelect.appendChild(new Option("Brak dostƒôpnych ciƒô≈ºar√≥wek", "", false, false)).disabled = true;
                } else {
                    data.ciezarowki.forEach(c => {
                        const option = new Option(`${c.marka} ${c.model} - ${c.koszt.toFixed(2)} PLN`, c.id);
                        option.dataset.koszt = c.koszt.toFixed(2);
                        ciezarowkaSelect.appendChild(option);
                    });
                }

                kierowcaSelect.disabled = false;
                ciezarowkaSelect.disabled = false;
                updateKoszt();
            })
            .catch(error => console.error("‚ùå B≈ÇƒÖd pobierania danych:", error));
    }

    function updateKoszt() {
        const kierowcaKoszt = parseFloat(kierowcaSelect.selectedOptions[0]?.dataset.koszt || 0);
        const ciezarowkaKoszt = parseFloat(ciezarowkaSelect.selectedOptions[0]?.dataset.koszt || 0);

        if (kierowcaKoszt && ciezarowkaKoszt) {
            kosztValue.textContent = (kierowcaKoszt + ciezarowkaKoszt).toFixed(2);
            lacznyKosztDiv.style.display = 'block';
        } else {
            lacznyKosztDiv.style.display = 'none';
        }
    }

    dataRozpoczecia.addEventListener('input', () => {
        clearTimeout(debounceTimeout);

        kierowcaSelect.innerHTML = "";
        ciezarowkaSelect.innerHTML = "";
        kierowcaSelect.appendChild(new Option("‚è≥ ≈Åadowanie kierowc√≥w...", "", false, false)).disabled = true;
        ciezarowkaSelect.appendChild(new Option("‚è≥ ≈Åadowanie ciƒô≈ºar√≥wek...", "", false, false)).disabled = true;
        kierowcaSelect.disabled = true;
        ciezarowkaSelect.disabled = true;

        debounceTimeout = setTimeout(() => {
            obliczDateZakonczenia();
        }, 0);
    });

    kierowcaSelect.addEventListener('change', updateKoszt);
    ciezarowkaSelect.addEventListener('change', updateKoszt);

    const teraz = new Date();
    teraz.setMinutes(teraz.getMinutes() - teraz.getTimezoneOffset());
    dataRozpoczecia.value = teraz.toISOString().slice(0, 16);

    kierowcaSelect.innerHTML = "";
    ciezarowkaSelect.innerHTML = "";
    kierowcaSelect.appendChild(new Option("‚è≥ ≈Åadowanie kierowc√≥w...", "", false, false)).disabled = true;
    ciezarowkaSelect.appendChild(new Option("‚è≥ ≈Åadowanie ciƒô≈ºar√≥wek...", "", false, false)).disabled = true;
    kierowcaSelect.disabled = true;
    ciezarowkaSelect.disabled = true;

    setTimeout(() => {
        obliczDateZakonczenia();
    }, 5);
});
</script>

    <script>
document.addEventListener("DOMContentLoaded", function () {
    console.log("üìç Inicjalizacja mapy...");

    let startCoordsWyj = {{ start_coords_wyj }};
    let startCoords = {{ start_coords|safe }};
    let endCoords = {{ end_coords|safe }};
    let routeGeometry = {{ route_geometry|safe }};
    let routeGeometryFromStartToPick = {{ route_geometry_from_start_to_pick|safe }};

    if (!startCoords || !endCoords || !routeGeometry || routeGeometry.length === 0) {
        console.error("üö® Brak danych do wy≈õwietlenia trasy!");
        return;
    }

    // Inicjalizacja mapy
    const map = L.map("map", {
        zoomControl: false,  // Usuniƒôcie domy≈õlnych przycisk√≥w zoomu (dodamy w≈Çasne)
        attributionControl: false,  // Ukrycie napis√≥w o ≈∫r√≥dle mapy
    }).setView(startCoords, 10);

    // üìå Warstwa OpenStreetMap (≈Çadniejszy styl)
    L.tileLayer("https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png", {
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // üì¶ Znacznik miejsca wyjazdu (≈º√≥≈Çty)
    L.marker([startCoordsWyj[1], startCoordsWyj[0]], {
        icon: L.icon({
            iconUrl: "https://maps.google.com/mapfiles/ms/icons/yellow-dot.png",
            iconSize: [40, 40],
            iconAnchor: [20, 40]
        })
    }).addTo(map).bindPopup("<b>üèÅ Miejsce wyjazdu</b><br>{{ zlecenie.miejsce_wyj }}");

    // üìç Znacznik miejsca odbioru (czerwony)
    L.marker([startCoords[1], startCoords[0]], {
        icon: L.icon({
            iconUrl: "https://maps.google.com/mapfiles/ms/icons/red-dot.png",
            iconSize: [40, 40],
            iconAnchor: [20, 40]
        })
    }).addTo(map).bindPopup("<b>üìç Miejsce odbioru</b><br>{{ zlecenie.miejsce_odb }}").openPopup();

    // üì¶ Znacznik miejsca dostawy (zielony)
    L.marker([endCoords[1], endCoords[0]], {
        icon: L.icon({
            iconUrl: "https://maps.google.com/mapfiles/ms/icons/green-dot.png",
            iconSize: [40, 40],
            iconAnchor: [20, 40]
        })
    }).addTo(map).bindPopup("<b>üì¶ Miejsce dostawy</b><br>{{ zlecenie.miejsce_dost }}");

    // üîÑ Trasy
    const routeStartPickLatLngs = routeGeometryFromStartToPick.map(coord => [coord[1], coord[0]]);
    const routeLatLngs = routeGeometry.map(coord => [coord[1], coord[0]]);

    const routeLineStartPick = L.polyline(routeStartPickLatLngs, {
        color: "red",
        weight: 5,
        opacity: 1,
        dashArray: "5, 5",
        lineJoin: "round"
    }).addTo(map);

    const routeLine = L.polyline(routeLatLngs, {
        color: "blue",
        weight: 6,
        opacity: 0.9,
        lineJoin: "round"
    }).addTo(map);

    // üéØ Dopasowanie widoku do wszystkich punkt√≥w
    const allPoints = [...routeStartPickLatLngs, ...routeLatLngs];
    map.fitBounds(L.latLngBounds(allPoints), { padding: [30, 30] });

    // üîç Przyciski zoomowania
    L.control.zoom({ position: "topright" }).addTo(map);

    // üìú Legenda
    const legend = L.control({ position: "bottomright" });

    legend.onAdd = function () {
        const div = L.DomUtil.create("div", "info legend");
        div.style.background = "white";
        div.style.padding = "10px 12px";
        div.style.borderRadius = "8px";
        div.style.boxShadow = "0 0 8px rgba(0, 0, 0, 0.3)";
        div.style.fontSize = "13px";
        div.style.lineHeight = "1.5";
        div.style.color = "#333";
        div.innerHTML = `
            <h6><strong>Legenda</strong></h6>
            <i style="background: #ff0000; border-radius:2px; width: 14px; height: 4px; display: inline-block; margin-right: 6px;"></i> Miejsce wyjazdu ‚Üí Odbi√≥r<br>
            <i style="background: blue; border-radius:2px; width: 14px; height: 4px; display: inline-block; margin-right: 6px;"></i> Odbi√≥r ‚Üí Dostawa
        `;
        return div;
    };

    legend.addTo(map);
});
</script>

{% endblock %}
